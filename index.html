<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 Crypto Dashboard – Fixed</title>
  <style>
    :root{
      --hdr-h:64px; --th-h:44px; --sticky-bg:#f8fbff;
      --w1:140px; --w2:160px; --w3:120px; --w4:140px; --w5:140px;
    }
    *{box-sizing:border-box}
    body{font-family:tahoma,Arial,sans-serif;background:#f5f7fb;margin:0}
    header{position:fixed;top:0;inset-inline:0;background:#1e88e5;color:#fff;z-index:1200}
    header .hwrap{max-width:1700px;margin:0 auto;padding:10px 12px}
    header h2{margin:.2rem 0 .1rem 0;font-weight:700}
    header .sub{font-size:12px;opacity:.9}
    .wrap{max-width:1700px;margin:calc(var(--hdr-h) + 12px) auto 16px auto;padding:0 12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input[type="text"],select,button{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px;font-family:inherit}
    button{background:#1e88e5;color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:#1e88e5;border-color:#90caf9}
    button:disabled{background:#90caf9;cursor:not-allowed}
    .note{font-size:12px;color:#546e7a;margin-top:6px}
    .table-wrap{overflow:auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:1600px;table-layout:auto;}
    col.symbol{width:var(--w1)} col.price{width:var(--w2)} col.rsi{width:var(--w3)} col.ema9{width:var(--w4)} col.ema20{width:var(--w5)}
    th,td{border-bottom:1px solid #e9eef5;padding:9px 10px;text-align:center;white-space:nowrap;font-size:13px;overflow:hidden;text-overflow:ellipsis;background-clip:padding-box}
    tbody td{border-bottom:2px solid #d5deea}
    .num{font-variant-numeric:tabular-nums;direction:ltr;text-align:right;line-height:1.35}
    thead th{background:#e3f2fd;color:#0d47a1;position:sticky;top:var(--hdr-h);z-index:1500;height:var(--th-h);box-shadow:0 1px 0 #e1eaf3;border-bottom:2px solid #cfd8e3;}
    tbody tr:nth-child(odd){background:#ffffff}
    tbody tr:nth-child(even){background:#fafcff}
    tr:hover{background:#f3f8ff}
    .positive{color:#2e7d32;font-weight:600}
    .negative{color:#c62828;font-weight:600}
    .badge{padding:2px 6px;border-radius:8px;font-weight:600}
    .good{background:#e8f5e9;color:#2e7d32}
    .bad{background:#ffebee;color:#c62828}
    .neutral{background:#eceff1;color:#37474f}
    .nowrap{white-space:nowrap}
    .rsi-high{color:#c62828;font-weight:700}
    .rsi-low{color:#2e7d32;font-weight:700}
    th.stk, td.stk{position:sticky;z-index:1400;will-change:transform;background:inherit}
    thead th.stk{background:#e3f2fd;z-index:1450}
    th.c1,td.c1{inset-inline-start:0}
    th.c2,td.c2{inset-inline-start:var(--w1)}
    th.c3,td.c3{inset-inline-start:calc(var(--w1) + var(--w2))}
    th.c4,td.c4{inset-inline-start:calc(var(--w1) + var(--w2) + var(--w3))}
    th.c5,td.c5{inset-inline-start:calc(var(--w1) + var(--w2) + var(--w3) + var(--w4))}
    th.stk::after, td.stk::after{content:"";position:absolute;top:0;bottom:0;inset-inline-end:-1px;width:1px;background:#e3eaf3;pointer-events:none}
    tbody tr.sticky-row{position:sticky;top:calc(var(--hdr-h) + var(--th-h));z-index:1000;background:var(--sticky-bg)}
    tbody tr.sticky-row td{background:var(--sticky-bg)}
  </style>
</head>
<body>
  <header>
    <div class="hwrap">
      <h2>📊 Crypto Dashboard – Fixed</h2>
      <div class="sub">منبع داده: Binance (OHLCV) از طریق Proxy | اندیکاتورها در مرورگر محاسبه می‌شوند</div>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <label>تایم‌فریم:</label>
      <select id="interval">
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
      <input id="search" type="text" placeholder="جستجوی نماد (BTC, ETH, ...)" />
      <button id="refreshBtn">بروزرسانی</button>
      <button id="downloadCSV">دانلود CSV</button>
      <button id="downloadXLS">دانلود Excel</button>
      <button id="clearSearch" class="ghost">پاک‌کردن</button>
      <span id="lastUpdate" class="note"></span>
    </div>

    <div class="table-wrap" id="tableWrap" style="max-height:85vh; overflow:auto;">
      <table id="crypto-table">
        <thead>
          <tr>
            <th class="stk c1">Symbol</th>
            <th class="stk c2">Price</th>
            <th class="stk c3">RSI(14)</th>
            <th class="stk c4">EMA9</th>
            <th class="stk c5">EMA20</th>
            <th>EMA50</th>
            <th>EMA100</th>
            <th>MACD</th>
            <th>Signal</th>
            <th>L</th>
            <th>S</th>
            <th>PP</th>
            <th>Long</th>
            <th>Short</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>Support</th>
            <th>Resistance</th>
            <th>روی حمایت؟</th>
            <th>روی مقاومت؟</th>
            <th>Breakout</th>
            <th>Bounce</th>
            <th>Golden Cross</th>
            <th>Rally</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const BINANCE = "https://api.binance.com";
const PROXIES = [
  (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  (url) => url
];

async function fetchViaProxies(url){
  for(const prox of PROXIES){
    try{
      const res = await fetch(prox(url));
      if(res.ok) return await res.json();
    }catch(e){}
  }
  throw new Error("Proxy error");
}

const SYMBOLS = ["BTCUSDT","ETHUSDT","BNBUSDT","XRPUSDT","SOLUSDT","ADAUSDT","DOGEUSDT"];

function fmt(n,d=2){return (n==null||isNaN(n))?"-":Number(n).toLocaleString(undefined,{maximumFractionDigits:d});}

function applySearch(){
  const q = (document.getElementById("search").value||"").trim().toUpperCase();
  const rows = Array.from(document.querySelectorAll("#crypto-table tbody tr"));
  let firstVisible=null;
  rows.forEach(r=>{
    const sym = (r.getAttribute("data-symbol")||"").toUpperCase();
    if(!q || sym.includes(q)){
      r.style.display=""; if(!firstVisible) firstVisible=r;
    }else r.style.display="none";
    r.classList.remove("sticky-row");
  });
  if(firstVisible) firstVisible.classList.add("sticky-row");
}

document.getElementById("search").addEventListener("input", applySearch);
document.getElementById("clearSearch").addEventListener("click", ()=>{document.getElementById("search").value="";applySearch();});

async function buildTable(){
  const tbody=document.querySelector("#crypto-table tbody");
  tbody.innerHTML="";
  for(const s of SYMBOLS){
    const tr=document.createElement("tr");
    tr.setAttribute("data-symbol",s);
    tr.innerHTML=`<td class="stk c1">${s}</td><td colspan="23">درحال بارگذاری...</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById("lastUpdate").textContent="آخرین بروزرسانی: "+new Date().toLocaleString();
}

window.addEventListener("load",()=>{buildTable();});
</script>
</body>
</html>
