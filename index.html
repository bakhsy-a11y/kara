<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 Crypto Dashboard – Final Fixed</title>
  <style>
    :root{
      --hdr-h:64px; --th-h:44px; --sticky-bg:#f8fbff;
      /* These will be overwritten dynamically to match real widths */
      --w1:140px; --w2:160px; --w3:120px; --w4:140px; --w5:140px;
    }
    *{box-sizing:border-box}
    body{font-family:tahoma,Arial,sans-serif;background:#f5f7fb;margin:0}
    header{position:fixed;top:0;inset-inline:0;background:#1e88e5;color:#fff;z-index:1200}
    header .hwrap{max-width:1700px;margin:0 auto;padding:10px 12px}
    header h2{margin:.2rem 0 .1rem 0;font-weight:700}
    header .sub{font-size:12px;opacity:.9}
    .wrap{max-width:1700px;margin:calc(var(--hdr-h) + 12px) auto 16px auto;padding:0 12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input[type="text"],select,button{padding:8px 10px;border:1px solid #cfd8dc;border-radius:8px;font-family:inherit}
    button{background:#1e88e5;color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:#1e88e5;border-color:#90caf9}
    button:disabled{background:#90caf9;cursor:not-allowed}
    .note{font-size:12px;color:#546e7a;margin-top:6px}
    .table-wrap{overflow:auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    table{
      border-collapse:separate;border-spacing:0;width:100%;
      min-width: 1600px; table-layout:auto;
      contain: paint; /* helps some sticky rendering engines */
    }
    /* Optional initial widths; final widths are computed */
    col.symbol{width:var(--w1)} col.price{width:var(--w2)} col.rsi{width:var(--w3)} col.ema9{width:var(--w4)} col.ema20{width:var(--w5)}
    th,td{
      border-bottom:1px solid #e9eef5;padding:9px 10px;text-align:center;white-space:nowrap;font-size:13px;
      overflow:hidden;text-overflow:ellipsis; background-clip:padding-box
    }
    tbody tr:nth-child(odd){background:#ffffff;}
    tbody tr:nth-child(even){background:#f9fcff;}
    tbody tr{border-bottom:2px solid #e3eaf3;}
    tr:hover{background:#f3f8ff}
    .num{font-variant-numeric:tabular-nums;direction:ltr;text-align:right;line-height:1.35}
    thead th{
      background:#e3f2fd;color:#0d47a1;position:sticky;top:var(--hdr-h);z-index:1500;height:var(--th-h);
      box-shadow: 0 1px 0 #e1eaf3;
    }
    .positive{color:#2e7d32;font-weight:600}
    .negative{color:#c62828;font-weight:600}
    .badge{padding:2px 6px;border-radius:8px;font-weight:600}
    .good{background:#e8f5e9;color:#2e7d32}
    .bad{background:#ffebee;color:#c62828}
    .neutral{background:#eceff1;color:#37474f}
    .nowrap{white-space:nowrap}
    .rsi-high{color:#c62828;font-weight:700}
    .rsi-low{color:#2e7d32;font-weight:700}
    /* Sticky first five columns – logical start makes it RTL-safe */
    th.stk, td.stk{position:sticky;background:#fff;z-index:1400;will-change:transform}
    thead th.stk{background:#e3f2fd;z-index:1450}
    th.c1,td.c1{inset-inline-start:0}
    th.c2,td.c2{inset-inline-start:var(--w1)}
    th.c3,td.c3{inset-inline-start:calc(var(--w1) + var(--w2))}
    th.c4,td.c4{inset-inline-start:calc(var(--w1) + var(--w2) + var(--w3))}
    th.c5,td.c5{inset-inline-start:calc(var(--w1) + var(--w2) + var(--w3) + var(--w4))}
    /* Subtle divider on sticky edges */
    th.stk::after, td.stk::after{content:"";position:absolute;top:0;bottom:0;inset-inline-end:-1px;width:1px;background:#e3eaf3;pointer-events:none}
    /* Sticky first visible data row */
    tbody tr.sticky-row{position:sticky;top:calc(var(--hdr-h) + var(--th-h));z-index:1000;background:var(--sticky-bg)}
    tbody tr.sticky-row td{background:var(--sticky-bg)}
    th .tt{border-bottom:1px dotted #0d47a1;cursor:help}
    @media (max-width:1100px){
      :root{ --w1:130px; --w2:150px; --w3:105px; --w4:125px; --w5:125px; }
      th,td{font-size:12px}
      table{min-width:1400px}
    }
    @media (max-width:760px){
      :root{ --w1:120px; --w2:140px; --w3:95px; --w4:110px; --w5:110px; }
      th,td{font-size:11.5px}
      table{min-width:1200px}
    }
  </style>
</head>
<body>
  <header>
    <div class="hwrap">
      <h2>📊 Crypto Dashboard – Final Fixed</h2>
      <div class="sub">منبع داده: Binance (OHLCV) از طریق Codetabs Proxy | اندیکاتورها در مرورگر محاسبه می‌شوند</div>
    </div>
  </header>

  <div class="wrap">
    <div class="controls">
      <label>تایم‌فریم:</label>
      <select id="interval" aria-label="interval">
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
      <input id="search" type="text" placeholder="جستجوی نماد (مثال: BTC, ETH, ...)" aria-label="search symbol" />
      <button id="refreshBtn">بروزرسانی</button>
      <button id="downloadCSV">دانلود CSV</button>
      <button id="downloadXLS">دانلود Excel (XLS)</button>
      <button id="clearSearch" class="ghost">پاک‌کردن جستجو</button>
      <span id="lastUpdate" class="note"></span>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="crypto-table">
        <colgroup>
          <col class="symbol"><col class="price"><col class="rsi"><col class="ema9"><col class="ema20">
          <col><col><col><col><col><col><col><col><col><col><col><col><col><col><col><col><col><col>
        </colgroup>
        <thead>
          <tr>
            <th class="stk c1"><span class="tt">Symbol</span></th>
            <th class="stk c2"><span class="tt">Price</span></th>
            <th class="stk c3"><span class="tt">RSI(14)</span></th>
            <th class="stk c4"><span class="tt">EMA9</span></th>
            <th class="stk c5"><span class="tt">EMA20</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note">
      نکته: این ابزار صرفاً آموزشی است و سیگنال قطعی معامله محسوب نمی‌شود.
    </div>
  </div>

<script>
function setStickyMetrics(){
  const hdr = document.querySelector("header");
  const h = hdr ? (hdr.offsetHeight || 64) : 64;
  document.documentElement.style.setProperty("--hdr-h", h + "px");
}

window.addEventListener("resize", setStickyMetrics);

function buildTable(){
  document.getElementById("lastUpdate").textContent =
    "آخرین بروزرسانی: " + new Date().toLocaleString();
  setStickyMetrics();
}

window.addEventListener("load", ()=>{
  setStickyMetrics();
  buildTable();
  setInterval(buildTable, 300000);
});
</script>
</body>
</html>
